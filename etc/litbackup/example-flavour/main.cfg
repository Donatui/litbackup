#!/bin/bash

# By vytenis.adm@gmail.com

# NOTE: order of these parameters is important

# # #  -- SHARED PARAMETERS ---

# Directory to store backups in:
BACKUPROOT="/backup"

# Where rsync should sync the latest files ( "/" at the end is needed):
BACKUPDIR="$BACKUPROOT/$SERVER/workdir/"

# Where a temporary list of files generated by FILELISTGENERATOR should be:
FILESLIST="/dev/shm/$SERVER-file-list-to-backup"

# # #  -- BACKUP SCRIPT PARAMETERS ---

# Folder list for a full rsync . Eg.":/path/to/file :/path/to/directory/" (see "man rsync"). Note - also used in "$FILELISTGENERATOR" find with stripped ":":
DIRSTOBACKUP=":/var/log :/etc :/home"

# Agent script to execute on remote server, which generates files to backup:
FILELISTGENERATOR="/opt/litbackup/filelist-generator.sh"

# List of directories (wildcard "*" allowed) to only delete changes.
# This is useful in e.g. large "/home" directories where users are added regularry
# to prevent daily full rsync of "/home". Only delete removed directories from backups.
# File must NOT contain a trailing "/":
DIRSNORECURSIONLIST="/etc/litbackup/$FLAVOR/no-recursion.cfg"

# Where a temporary file with of directories not to recurse should be. Normally you shouldn't edit this:
NORECURSEDIRS="/dev/shm/$SERVER-no-recursion-list"

# Uncomment to force monthly full backups - for a piece of mind, just in case. Define a day of month - either fixed (0..28) or generated from $SERVER to balance automatically:
FORCEFULLON=`echo $SERVER|md5sum|tr -d [:alpha:] | awk '{print substr($1,3,2) % 28}'`

# File with the list if files rsync should exclude (see "--exclude-from" in "man rsync" for syntax):
EXCLUDESFILE="/etc/litbackup/$FLAVOR/backup-excludes.cfg"

# Secret key file to use when connecting to remote server (for rsync, ssh and scp to use):
SSHPRIVATEKEY="/etc/ssh/ssh_host_rsa_key"

# SSH user to connect as:
SSHUSER="root"

# SSH port to use:
SSHPORT="22"

# Full rsync with ssh parameters command to execute. This is used when doing an initial backup - it sync's all files.:
FULLRSYNC="/usr/bin/rsync -rqaR --delete --delete-excluded  -v --numeric-ids --exclude-from=$EXCLUDESFILE -e \"ssh -c arcfour -p $SSHPORT -o StrictHostKeyChecking=no -o ServerAliveInterval=30 -i $SSHPRIVATEKEY\" $SSHUSER@$SERVER$DIRSTOBACKUP $BACKUPDIR"

# Periodic rsync with ssh parameters command to execute. This is used when doing a periodic (daily) backup. It syncs only certain files:
REGULARRSYNC="/usr/bin/rsync -rqaRO --whole-file --delete  -v --numeric-ids --files-from=$FILESLIST --exclude-from=$EXCLUDESFILE -e \"ssh -c arcfour -p $SSHPORT -o StrictHostKeyChecking=no -o ServerAliveInterval=30 -i $SSHPRIVATEKEY\" $SSHUSER@$SERVER:/ $BACKUPDIR"

# What to do with non-recursive directories. Default: sync without recursion.
NORECURSIONRSYNC="/usr/bin/rsync -qR --delete -v --ignore-existing --existing --files-from=$NORECURSEDIRS -e \"ssh -c arcfour -p $SSHPORT -o StrictHostKeyChecking=no -o ServerAliveInterval=30 -i $SSHPRIVATEKEY\" $SSHUSER@$SERVER:/ $BACKUPDIR"

# # #  -- ROTATION SCRIPT PARAMETERS ---

# Before which hour treat successfull backups as yesterdays (0..23). Eg. if set to 5, backups finished on 0:01, 3:34, 4:59 and so on will be dated with yesterdays date.
LASTDAYBEFOREHOUR=5

# How many backups (daily, weekly and monthly) to store:
NUMOFDAILY=3
NUMOFWEEKLY=2
NUMOFMONTHLY=2

# On which weekday to move weeklies (1..7):
WEEKLYDAY=7

# On which month day to move monthlies (1..28):
MONTHLYDAY=1

# Compression: find all files in last backup with no hard links and compress them ("yes" or anything else for "no"):
COMPRESSFILES="no"

# Suffix for "gzip -S" to add. Must be unique to distinguish:
GZIPSUFFIX=".TYyiulghkUItyio-BACKUP.gz"

#  "find" and "gzip" (or "pigz") parameters to use for compression:
COMPRESSFINDPARAMS="-type f -links 1 -size +1M -not -iname \"*jpg\" -not -iname \"*gif\" -not -iname \"*avi\" -not -iname \"*.tar*\" -not -name \"*.tgz\" -not -name \"*.gz\" -exec gzip -q --fast -S $GZIPSUFFIX {} \;"

#  "rsync" changes permissions of hard links. This leads to ALL versions of the same file permissions changed. Backup permissions to a separate file?:
BACKUPPERMISSIONS="no"